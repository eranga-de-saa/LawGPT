name: CI

on:
  push:
    branches: ["main"]
  pull_request:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      PROJECT_ID: law-gpt-487518
      PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER }}
      ZONE: us-west1-a
      CLUSTER: lawgpt-cluster
      USE_GKE_GCLOUD_AUTH_PLUGIN: "True"

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install backend deps
        run: |
          cd Back-end
          npm install

      - name: Install frontend deps
        run: |
          cd Front-end
          npm install

      - name: Build backend
        run: |
          cd Back-end
          npm run build || true

      - name: Build frontend
        run: |
          cd Front-end
          npm run build || true

      - name: Docker build backend
        run: docker build -t lawgpt-backend ./Back-end

      - name: Docker build frontend
        run: docker build -t lawgpt-frontend ./Front-end

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ env.PROJECT_NUMBER }}/locations/global/workloadIdentityPools/github-pool/providers/github-provider
          service_account: github-actions@law-gpt-487518.iam.gserviceaccount.com

        # Setup gcloud
      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      # Configure Docker for Artifact Registry
      - name: Configure Docker
        run: |
          gcloud auth configure-docker us-west1-docker.pkg.dev --quiet

      # # Tag & push backend
      # - name: Push backend image
      #   run: |
      #     docker tag lawgpt-backend \
      #       us-west1-docker.pkg.dev/law-gpt-487518/backend/backend:latest
      #     docker push us-west1-docker.pkg.dev/law-gpt-487518/backend/backend:latest

      # # Tag & push frontend
      # - name: Push frontend image
      #   run: |
      #     docker tag lawgpt-frontend \
      #       us-west1-docker.pkg.dev/law-gpt-487518/frontend/frontend:latest
      #     docker push us-west1-docker.pkg.dev/law-gpt-487518/frontend/frontend:latest
      # Tag & push backend
      - name: Push backend image
        run: |
          # Define the base image name
          IMAGE_NAME=us-west1-docker.pkg.dev/law-gpt-487518/backend/backend

          # 1. Tag with the unique Commit SHA (Permanent History)
          docker tag lawgpt-backend $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:${{ github.sha }}

          # 2. Tag with 'latest' (Convenience)
          docker tag lawgpt-backend $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest

      # Tag & push frontend
      - name: Push frontend image
        run: |
          # Define the base image name
          IMAGE_NAME=us-west1-docker.pkg.dev/law-gpt-487518/frontend/frontend

          # 1. Tag with the unique Commit SHA (Permanent History)
          docker tag lawgpt-frontend $IMAGE_NAME:${{ github.sha }}
          docker push $IMAGE_NAME:${{ github.sha }}

          # 2. Tag with 'latest' (Convenience)
          docker tag lawgpt-frontend $IMAGE_NAME:latest
          docker push $IMAGE_NAME:latest
